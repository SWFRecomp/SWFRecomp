# WASM Wrappers

This directory contains minimal wrapper files used for building SWFRecomp tests to WebAssembly.

## Purpose

Instead of duplicating runtime files in each test directory, we maintain a single set of WASM wrapper files that can be used by all tests. This approach:

- ✅ Eliminates ~700 lines of duplicated code per test
- ✅ Uses the production-quality SWFModernRuntime library
- ✅ Makes enabling WASM for new tests trivial
- ✅ Ensures consistency across all WASM builds

## Files

### `main.c`

Minimal entry point that:
- Initializes the WASM runtime
- Exports `runSWF()` function for JavaScript to call
- Delegates to `swfStart(frame_funcs)` from SWFModernRuntime

This file is copied into each test's `build/wasm/` directory during compilation.

### `index_template.html`

HTML template with interactive controls for running recompiled SWF files in the browser.

Features:
- Interactive "Run SWF" button
- Console output display
- Status indicators
- Dark theme UI

The build script replaces `{{TEST_NAME}}` placeholder with the actual test name.

## Usage

These files are used automatically by the build scripts. You don't need to manually copy or edit them.

To build a test with WASM:

```bash
cd SWFRecomp
./scripts/build_test.sh <test_name> wasm
```

The build script will:
1. Copy `main.c` to `tests/<test_name>/build/wasm/`
2. Copy `index_template.html` to `tests/<test_name>/build/wasm/index.html`
3. Replace `{{TEST_NAME}}` with the actual test name
4. Compile everything with Emscripten

## Architecture

```
┌─────────────────────────────────────────────────────┐
│ Test Directory (tests/trace_swf_4/)                 │
│  ├── test.swf                 (test input)          │
│  ├── config.toml              (SWFRecomp config)    │
│  ├── RecompiledScripts/       (generated by tool)   │
│  └── RecompiledTags/          (generated by tool)   │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│ Build Process                                        │
│  1. Copy wasm_wrappers/main.c                       │
│  2. Copy SWFModernRuntime sources                   │
│  3. Copy generated code                             │
│  4. Compile with emcc                               │
└─────────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────┐
│ Output (build/wasm/)                                 │
│  ├── trace_swf_4.wasm         (WebAssembly binary)  │
│  ├── trace_swf_4.js           (Emscripten loader)   │
│  └── index.html               (Browser interface)   │
└─────────────────────────────────────────────────────┘
```

## Runtime Library

These wrappers work in conjunction with **SWFModernRuntime**, a production-quality ActionScript VM that provides:

- Full ActionScript operator support (add, subtract, multiply, etc.)
- Advanced variable storage (HashMap + Array optimization)
- String operations and type conversions
- Proper memory management
- Built-in functions (trace, getTime, etc.)

See the SWFModernRuntime repository for more details.

## Modifying the Wrappers

If you need to change how WASM builds work:

1. Edit `main.c` or `index_template.html` in this directory
2. Rebuild affected tests with `./scripts/build_test.sh`
3. Changes will apply to all future builds automatically

## Template Placeholders

The following placeholders are automatically replaced by the build script:

- `{{TEST_NAME}}` - Replaced with the test directory name (e.g., "trace_swf_4")

## See Also

- `SWFRecomp/scripts/build_test.sh` - Main build script
- `SWFModernRuntime/` - Runtime library
- `SWFRecompDocs/plans/streamline-test-builds.md` - Architecture documentation
